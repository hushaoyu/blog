---
title: G6ä½¿ç”¨æ‰‹å†Œ
date: 2022-06-09 10:04:59
tags: [G6]
categories: [G6]
---
#### ç®€ä»‹
> `G6` æ˜¯ä¸€ä¸ªå›¾å¯è§†åŒ–å¼•æ“ã€‚å®ƒæä¾›äº†å›¾çš„ç»˜åˆ¶ã€å¸ƒå±€ã€åˆ†æã€äº¤äº’ã€åŠ¨ç”»ç­‰å›¾å¯è§†åŒ–çš„åŸºç¡€èƒ½åŠ›ã€‚æ—¨åœ¨è®©å…³ç³»å˜å¾—é€æ˜ï¼Œç®€å•ã€‚è®©ç”¨æˆ·è·å¾—å…³ç³»æ•°æ®çš„ `Insight`ã€‚

#### ä½¿ç”¨æŠ€å·§
##### 1ã€æ‹–æ‹½æ·»åŠ èŠ‚ç‚¹
- æ˜¾ç¤ºåœ¨å·¦ä¾§ `itemPanel` çš„èŠ‚ç‚¹å…ƒç´ 
```javascript
itemList = {
  G6Node: [
    {
      type: 'top_text',
      label: 'æ–‡æœ¬',
      img: 'text',
    },
    {
      type: 'top_ellipse',
      label: 'åœ†å½¢',
      img: 'circle',
    },
    {
      type: 'top_rect',
      label: 'çŸ©å½¢',
      img: 'rect',
    }
  ]
}
```
- æ ¹æ®é…ç½®æ•°æ®æ¸²æŸ“ `DOM`
  - è®¾ç½® `img` å…ƒç´ çš„ `draggable` å±æ€§ä¸º `true`ï¼Œå¯æ‹–æ‹½
  - è®¾ç½® `data-type` å±æ€§ï¼Œç”¨äºäº‹ä»¶ç›‘å¬ä¸­ä¼ é€’ `type` å±æ€§ï¼Œè¡¨ç¤ºåˆ›å»ºçš„ `G6` èŠ‚ç‚¹çš„ç±»å‹
```javascript
_.get(this.props, 'data.G6Node', []).map(({ img, id, type, label }, index) => {
    return (
        <Row key={index}>
            <Col>
                <img
                    alt={label}
                    data-type={type}
                    className='item-drag'
                    draggable={"true"}
                    width={_.get(this.props, 'config.width', 50)}
                    height={_.get(this.props, 'config.height', 50)}
                    src={require(`../../assets/images/3d/${img}.svg`)}
                />
            </Col>
            <Col offset={1}>
                <span style={{marginRight: 5}}>{label}</span>
            </Col>
        </Row>
    )
})
```
- `ItemPanel` é˜»æ­¢`drop` äº‹ä»¶çš„é»˜è®¤è¡Œä¸ºï¼Œå¹¶æ·»åŠ  `dragend` äº‹ä»¶ç›‘å¬å™¨
```jsx
componentDidMount() {
  // é˜»æ­¢é»˜è®¤åŠ¨ä½œ
  document.addEventListener('drop', e => {
    e.preventDefault();
  }, false);
  if (this.panelRef.current) {
    // å½“é¡µé¢å®¹å™¨å…ƒç´ ç»˜åˆ¶å®Œæˆåï¼Œç»™å®¹å™¨ç»‘å®šæ‹–åŠ¨ç»“æŸäº‹ä»¶ï¼Œè°ƒç”¨çˆ¶ç»„ä»¶å‡½æ•°ï¼Œæ·»åŠ èŠ‚ç‚¹
    this.panelRef.current.addEventListener('dragend', this.dragendListener);
  }
}

dragendListener = (e) => {
  this.props.dragAddNode(e);
}

componentWillUnmount() {
  // åœ¨ç»„ä»¶å¸è½½å‰ï¼Œç§»é™¤ç›‘å¬å™¨
  this.panelRef.current ? this.panelRef.current.removeEventListener('dragend', this.dragendListener) : void 0;
}
```
- <span id="drag-add-node">çˆ¶ç»„ä»¶ä¸­å®ç°çš„æ·»åŠ èŠ‚ç‚¹é€»è¾‘</span>
```jsx
// æ‹–æ‹½æ·»åŠ èŠ‚ç‚¹
dragAddNode = (e) => {
    const {width: popWidth, height: popHeight, angleX, angleY} = this.props.polygonConfig || {};
    if (this.graph.getCurrentMode() === 'edit') {
        const type = e.target.getAttribute('data-type');
        /**
         * å½“ source ä¸º default æ—¶ï¼Œè¡¨æ˜å½“å‰æ·»åŠ çš„ä¸ºç»„ä»¶å†…ç½®èŠ‚ç‚¹
         * å½“source ä¸ä¸º default æ—¶ï¼Œè¡¨æ˜å½“å‰æ·»åŠ çš„ä¸ºä¸Šä¼ å›¾ç‰‡ç”Ÿæˆçš„è‡ªå®šä¹‰èŠ‚ç‚¹
         * img éœ€è¦urlç±»å‹
         * */
        const img = e.target.getAttribute('data-imgsrc');
        const source = e.target.getAttribute('data-source');
        switch (type) {
            default:
                this.graph.addItem('node', {
                    type,
                    x: _.get(this.props, 'canvasOffset.dx', 0),
                    y: _.get(this.props, 'canvasOffset.dy', 0),
                    img,
                    source,
                    anchorPoints: getAnchorPoints(type)
                });
                // å­—ä½“å›¾æ ‡èŠ‚ç‚¹ï¼Œéœ€æ‰‹åŠ¨è§¦å‘å­—ä½“è‡ªåŠ¨åŠ è½½
                if (type.indexOf('iconfont') >= 0) {
                    setTimeout(() => {
                        this.graph.paint();
                    }, 200);
                }
                break;
        }
    }
}
```
- ä¸ºå‡†ç¡®å°†èŠ‚ç‚¹æ·»åŠ è‡³é¼ æ ‡é‡Šæ”¾çš„å±å¹•ä½ç½®ï¼Œéœ€è¦è·å–å½“å‰é¼ æ ‡é‡Šæ”¾æ—¶çš„åœ¨å›¾å†…çš„ `canvas` åæ ‡ï¼Œ`G6` çš„ `drop` äº‹ä»¶è¿”å›çš„æ•°æ®å†…å°±åŒ…å«äº†æ”¹å±æ€§ï¼Œç›´æ¥è·å–å³å¯ã€‚
```jsx
this.graph.on('drop', e => {
    if (this.graph.getCurrentMode() === 'edit') {
        const dx = e.x;
        const dy = e.y;
        this.props.setDropCursorOffsetAction({
            dx,
            dy
        });
    }
})
```

![æ‹–æ‹½æ·»åŠ èŠ‚ç‚¹](https://hsj-studio.oss-cn-shanghai.aliyuncs.com/blog/articles/G6%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/%E6%8B%96%E6%8B%BD%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9.gif)
##### 2ã€å­—ä½“å›¾æ ‡èŠ‚ç‚¹
- å‚è€ƒ `G6` å®˜ç½‘ï¼Œä¸‹è½½å­—ä½“å›¾æ ‡ï¼š[ğŸ”—](https://g6.antv.vision/zh/docs/manual/advanced/iconfont/#%E6%B7%BB%E5%8A%A0%E5%AD%97%E4%BD%93%E5%9B%BE%E6%A0%87)
- å°†ä¸‹è½½å¥½çš„å­—ä½“å›¾æ ‡æ–‡ä»¶æ”¾åœ¨é¡¹ç›®çš„é™æ€èµ„æºç›®å½•ï¼Œå¦‚ `src/assets`

![å­—ä½“å›¾æ ‡æ–‡ä»¶ç¤ºä¾‹](https://hsj-studio.oss-cn-shanghai.aliyuncs.com/blog/articles/G6%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/%E5%AD%97%E4%BD%93%E5%9B%BE%E6%A0%87%E6%96%87%E4%BB%B6%E7%A4%BA%E4%BE%8B.png)
- åœ¨ç¨‹åºçš„å…¥å£æ–‡ä»¶ä¸­å¼•å…¥å­—ä½“å›¾æ ‡çš„ `js` åŠ `css` æ–‡ä»¶ï¼Œå¦‚ï¼š
  ```javascript
  import '../assets/font_dpm/iconfont';
  import '../assets/font_dpm/iconfont.css';
  ```
- å¦‚å®˜ç½‘æ–‡æ¡£ä¸­æç¤ºï¼ŒèŠ‚ç‚¹ä¸­çš„ `fontFamily` å±æ€§å¯¹åº”å­—ä½“å›¾æ ‡çš„ `fontFamily` å±æ€§ï¼Œå¯ä»å­—ä½“å›¾æ ‡çš„ `json` æ–‡ä»¶ä¸­æŸ¥çœ‹
  ```json
  {
    "id": "2730284",
    "name": "dpmé¡¹ç›®",
    "font_family": "iconfont",
    "css_prefix_text": "icon-",
    "description": "",
    "glyphs": [
        {
        "icon_id": "5093336",
        "name": "å»ºç­‘",
        "font_class": "jianzhu",
        "unicode": "e601",
        "unicode_decimal": 58881
        }
    ]
  }
  ```
- åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨å­—ä½“å›¾æ ‡çš„ `unicode` å€¼æ‹¼æ¥ `\u` æ¥è¿›è¡Œèµ‹å€¼ï¼Œè¿™æ ·çš„æ–‡æœ¬æ ¼å¼æ˜¯ä¼šè¢«è½¬æ¢çš„ï¼Œç¨‹åºæ— æ³•æ­£å¸¸è¯†åˆ«ï¼Œéœ€è¦é€šè¿‡ `unicode` å¯¹åº”çš„åè¿›åˆ¶å€¼æ¥è¿›è¡Œè½¬æ¢ã€‚å…·ä½“å‚è€ƒ [MDN String.fromCodePoint](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/fromCodePoint). `unicode` çš„åè¿›åˆ¶å€¼å³å­—ä½“å›¾æ ‡ `json` æ–‡ä»¶ä¸­çš„ `unicode_decimal` å±æ€§ã€‚
- å®šä¹‰å·¥å…·å‡½æ•°
```javascript
import fonts from '../fonts/iconfont.json';

const icons = fonts.glyphs.map((icon) => {
  return {
    name: icon.name,
    unicode: String.fromCodePoint(icon.unicode_decimal),
  };
});
/**
 * desc æ ¹æ®åç§°è·å–å­—ä½“å›¾æ ‡çš„unicodeå€¼
 * @param name {string} å­—ä½“å›¾æ ‡å¯¹åº”çš„åç§°ï¼Œå€¼å‚è€ƒiconfont.jsonæ–‡ä»¶
 * */
const getIcon = (type: string) => {
  const matchIcon = icons.find((icon) => {
    return icon.name === type;
  }) || { unicode: '', name: 'default' };
  return matchIcon.unicode;
}
/**
 * desc è¿”å›å½“å‰æ‰€æœ‰çš„å­—ä½“å›¾æ ‡
 * */
export function getIconNames() {
  return icons;
}
```
- æ³¨å†Œå­—ä½“å›¾æ ‡èŠ‚ç‚¹
```javascript
return groupContainer.addShape('text', {
  attrs: {
    ...pickedConfig,
    fontFamily: constants.defaultConfig.common.iconFontFontFamily, // å¯¹åº”cssé‡Œé¢çš„font-family: "iconfont";
    textAlign: 'center',
    textBaseline: 'middle',
    text: getIcon(fontText),
    x: width/2,
    y: height/2,
  },
});
```
- å°†æ‰€æœ‰çš„å­—ä½“å›¾æ ‡æ¸²æŸ“åˆ°é¡µé¢ï¼Œç”¨æˆ·ç‚¹å‡»å¯¹åº”çš„å­—ä½“å›¾æ ‡ç¡®å®šåï¼Œåœ¨å›¾ä¸­ç”Ÿæˆå¯¹åº”çš„èŠ‚ç‚¹
```javascript
getIconNames().map(({name, unicode}) => (
        <Button key={unicode} onClick={() => {
          this.setState({
            fieldChangedKey: this.state.fieldChangedKey + 1,
            fieldChangedValue: {
              fontText: name
            }
          });
          this.props.form.setFieldsValue({
            fontText: name
          });
        }} type='dashed'>
          <span className='iconfont' title={name}>{unicode}</span>
        </Button>
))
```

![create-iconfont-node](https://hsj-studio.oss-cn-shanghai.aliyuncs.com/blog/articles/G6%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/%E5%88%9B%E5%BB%BA%E5%AD%97%E4%BD%93%E5%9B%BE%E6%A0%87%E8%8A%82%E7%82%B9.gif)
- ç¬¬ä¸€æ¬¡æ·»åŠ èŠ‚ç‚¹ï¼Œæœ‰æ—¶å€™ä¼šå‡ºç°åªæ˜¾ç¤ºä¸€ä¸ªé»‘æ¡†çš„é—®é¢˜ï¼Œè¿™æ˜¯å› ä¸ºæ­¤æ—¶å­—ä½“å¯èƒ½è¿˜æ²¡åŠ è½½ï¼Œå¯¼è‡´æ ¹æ® `unicode` æ— æ³•æ­£å¸¸è§£æï¼Œå¯æ‰‹åŠ¨è§¦å‘å­—ä½“è‡ªåŠ¨åŠ è½½æ¥è§£å†³ï¼Œå…·ä½“å¯å‚è€ƒ [æ–‡å†…é“¾æ¥](#drag-add-node)